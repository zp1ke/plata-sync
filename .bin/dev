#!/usr/bin/env bash

set -e  # Exit on error

# Navigate to project root
cd "$(dirname "$(dirname "$(readlink -f "$0")")")"
root_dir=$(pwd)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
function log_info {
  echo -e "${BLUE}ℹ${NC} $1"
}

function log_success {
  echo -e "${GREEN}✓${NC} $1"
}

function log_error {
  echo -e "${RED}✗${NC} $1" >&2
}

function log_warning {
  echo -e "${YELLOW}⚠${NC} $1"
}

function do_clean {
  log_info "Cleaning..."
  flutter clean
  log_success "Clean completed"
}

function do_deps {
  log_info "Getting dependencies..."
  flutter pub get
  log_success "Dependencies updated"
}

function do_test {
  log_info "Running tests..."
  flutter test
  log_success "Tests completed"
}

function do_run {
  log_info "Starting app..."
  flutter run "$@"
}

function do_build {
  local platform="${1:-}"
  if [[ -z "$platform" ]]; then
    log_error "Please specify a platform (android, ios, web, linux, windows, macos)"
    exit 1
  fi
  shift # remove platform from args
  # if platform is "android", change to "appbundle" for flutter build
  if [[ "$platform" == "android" ]]; then
    platform="appbundle"
  fi

  log_info "Building for $platform..."
  flutter build "$platform" "$@"
  log_success "Build completed"
}

function do_version {
  local bump_type="${1:-}"
  local pubspec_file="$root_dir/pubspec.yaml"

  if [[ ! -f "$pubspec_file" ]]; then
    log_error "pubspec.yaml not found at: $pubspec_file"
    exit 1
  fi

  local current_version
  current_version=$(grep -oP '^version: \K.*' "$pubspec_file")

  if [[ -z "$bump_type" ]]; then
    echo -e "${BLUE}Current Version:${NC} ${GREEN}$current_version${NC}"
    return 0
  fi

  # Split version into base and build number (if any)
  local base_version
  local build_number
  if [[ "$current_version" == *"+"* ]]; then
      base_version=$(echo "$current_version" | cut -d'+' -f1)
      build_number=$(echo "$current_version" | cut -d'+' -f2)
  else
      base_version="$current_version"
      build_number=""
  fi

  IFS='.' read -r major minor patch <<< "$base_version"

  # Ensure we have numbers
  major=${major:-0}
  minor=${minor:-0}
  patch=${patch:-0}

  case $bump_type in
    major)
      major=$((major + 1))
      minor=0
      patch=0
      ;;
    minor)
      minor=$((minor + 1))
      patch=0
      ;;
    patch)
      patch=$((patch + 1))
      ;;
    *)
      log_error "Invalid bump type: $bump_type (use: major, minor, patch)"
      exit 1
      ;;
  esac

  # Handle build number
  if [[ -z "$build_number" ]]; then
      build_number=1
  else
      build_number=$((build_number + 1))
  fi

  local new_version="$major.$minor.$patch+$build_number"

  # Update the file
  sed -i "s/^version: .*/version: $new_version/" "$pubspec_file"

  log_success "Version updated: $current_version → $new_version"
}

function help_message {
  echo -e "${BLUE}plata-sync Development Script (Flutter)${NC}"
  echo ""
  echo -e "${GREEN}Usage:${NC}"
  echo "  ./dev <command> [options]"
  echo ""
  echo -e "${GREEN}Commands:${NC}"
  echo -e "  ${YELLOW}clean${NC}                    Clean build artifacts"
  echo -e "  ${YELLOW}deps${NC}                     Get dependencies"
  echo -e "  ${YELLOW}test${NC}                     Run tests"
  echo -e "  ${YELLOW}run${NC} [args]               Run application (passes args to flutter run)"
  echo -e "  ${YELLOW}build${NC} <platform> [args]  Build application (android, ios, web, linux, windows, macos)"
  echo -e "  ${YELLOW}version${NC} [type]           Display or bump version (type: major|minor|patch)"
  echo -e "  ${YELLOW}help${NC}                     Show this help message"
  echo ""
}

function do_start {
  command=$1
  shift

  case $command in
    clean)
      do_clean "$@"
      ;;
    deps)
      do_deps "$@"
      ;;
    test)
      do_test "$@"
      ;;
    run)
      do_run "$@"
      ;;
    build)
      do_build "$@"
      ;;
    version)
      do_version "$@"
      ;;
    ""|"help")
      help_message
      ;;
    *)
      log_error "Unknown command: $command"
      echo ""
      help_message
      exit 1
      ;;
  esac
}

do_start "$@"
